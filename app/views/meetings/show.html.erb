<% content_for(:title) { "#{@meeting.body_name} - #{@meeting.starts_at&.strftime('%B %d, %Y')} - Two Rivers Reporter" } %>

<div class="page-header">
  <h1 class="page-title"><%= @meeting.body_name %></h1>
</div>

<div class="meeting-meta">
  <div class="meeting-meta-item">
    <span class="meeting-meta-label">Date & Time</span>
    <span class="meeting-meta-value"><%= @meeting.starts_at&.strftime("%B %d, %Y at %l:%M %p") %></span>
  </div>
  <div class="meeting-meta-item">
    <span class="meeting-meta-label">Status</span>
    <span class="badge <%= case @meeting.status
      when 'minutes_posted' then 'badge--success'
      when 'upcoming' then 'badge--primary'
      else 'badge--default'
    end %>">
      <%= @meeting.status.titleize %>
    </span>
  </div>
  <div class="meeting-meta-item">
    <span class="meeting-meta-label">Original Source</span>
    <span class="meeting-meta-value">
      <%= link_to "View on City Website", @meeting.detail_page_url, target: "_blank", rel: "noopener" %>
    </span>
  </div>
</div>

<% if @meeting.meeting_summaries.any? %>
  <div class="ai-content">
    <div class="ai-content-header">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--color-ai-text);">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
      <h2>
        <% if @meeting.meeting_summaries.exists?(summary_type: "minutes_recap") %>
          Meeting Recap
        <% else %>
          Packet Analysis
        <% end %>
      </h2>
    </div>
    <div class="prose">
      <%= markdown @meeting.meeting_summaries.last.content %>
    </div>
    <div class="ai-content-disclaimer">
      Generated by AI based on official documents. Always verify with original sources.
    </div>
  </div>
<% end %>

<% if @meeting.motions.any? %>
  <section class="section">
    <h2>Voting Record</h2>
    <div class="voting-record">
      <% @meeting.motions.each do |motion| %>
        <div class="motion">
          <div class="motion-description">
            <strong>Motion:</strong> <%= motion.description %>
          </div>

          <div class="motion-outcome mt-2">
            <strong>Outcome:</strong>
            <span class="badge <%= case motion.outcome.downcase
              when 'passed' then 'badge--success'
              when 'failed' then 'badge--danger'
              else 'badge--default'
            end %>">
              <%= motion.outcome.titleize %>
            </span>
          </div>

          <% if motion.votes.any? %>
            <details>
              <summary>View Votes (<%= motion.votes.count %>)</summary>
              <div class="votes-grid">
                <% motion.votes.includes(:member).each do |vote| %>
                  <div class="vote-card">
                    <%= link_to vote.member.name, member_path(vote.member) %>
                    <span class="vote-value vote-value--<%= vote.value %>">
                      <%= vote.value.titleize %>
                    </span>
                  </div>
                <% end %>
              </div>
            </details>
          <% end %>
        </div>
      <% end %>
    </div>
  </section>
<% end %>

<% if @meeting.agenda_items.any? %>
  <section class="section">
    <h2>Agenda</h2>
    <div class="agenda-list">
      <% @meeting.agenda_items.order(:order_index).each do |item| %>
        <div class="agenda-item" id="item-<%= item.id %>">
          <div class="agenda-item-title">
            <% if item.number.present? %>
              <span class="agenda-item-number"><%= item.number %></span>
            <% end %>
            <%= item.title %>
          </div>

          <% if item.topics.any? %>
            <div class="tags mt-2">
              <% item.topics.each do |topic| %>
                <%= link_to topic.name, topic_path(topic), class: "tag" %>
              <% end %>
            </div>
          <% end %>

          <% if item.summary.present? %>
            <div class="agenda-item-summary">
              <strong>Summary:</strong> <%= item.summary %>
            </div>
          <% end %>

          <% if item.recommended_action.present? %>
            <div class="agenda-item-action">
              <strong>Action:</strong> <%= item.recommended_action %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </section>
<% end %>

<section class="section">
  <h2>Documents</h2>

  <% if @meeting.meeting_documents.any? %>
    <div class="card">
      <ul class="documents-list">
        <% @meeting.meeting_documents.each do |doc| %>
          <li>
            <div>
              <span class="document-type"><%= doc.document_type.humanize %></span>
              <% if doc.file.attached? && doc.document_type.include?("pdf") %>
                <span class="document-meta">
                  (<%= number_to_human_size(doc.file.byte_size) %>)
                  <% if doc.text_quality.present? %>
                    - Quality: <%= doc.text_quality.humanize %>
                  <% end %>
                </span>
              <% end %>
            </div>
            <div>
              <% if doc.file.attached? && doc.document_type.include?("pdf") %>
                <%= link_to "Download PDF", rails_blob_path(doc.file, disposition: "attachment"), class: "btn btn--secondary btn--sm" %>
              <% else %>
                <%= link_to "View Original", doc.source_url, target: "_blank", rel: "noopener", class: "btn btn--secondary btn--sm" %>
              <% end %>
            </div>
          </li>
        <% end %>
      </ul>
    </div>
  <% else %>
    <div class="card">
      <p class="text-secondary mb-0">No documents found for this meeting.</p>
    </div>
  <% end %>
</section>

<%= link_to meetings_path, class: "back-link" do %>
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <line x1="19" y1="12" x2="5" y2="12"></line>
    <polyline points="12 19 5 12 12 5"></polyline>
  </svg>
  Back to Meetings
<% end %>
