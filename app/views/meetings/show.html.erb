<h1><%= @meeting.body_name %></h1>

<p>
  <strong>Date:</strong>
  <%= @meeting.starts_at&.strftime("%B %d, %Y %l:%M %p") %>
</p>

<p>
  <strong>Status:</strong>
  <%= @meeting.status.titleize %>
</p>

<p>
  <strong>Original Source:</strong>
  <%= link_to "View on City Website", @meeting.detail_page_url, target: "_blank" %>
</p>

<% if @meeting.meeting_summaries.any? %>
  <div style="background-color: #f0f7ff; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
    <h2>
      <% if @meeting.meeting_summaries.exists?(summary_type: "minutes_recap") %>
        Meeting Recap
      <% else %>
        Packet Analysis
      <% end %>
    </h2>
    <div class="prose">
      <%= markdown @meeting.meeting_summaries.last.content %>
    </div>
    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
      <em>Generated by AI based on official documents. Verify with original sources.</em>
    </div>
  </div>
<% end %>

<% if @meeting.motions.any? %>
  <div style="background-color: #fff; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 30px;">
    <h2>Voting Record</h2>
    <% @meeting.motions.each do |motion| %>
      <div class="motion" style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
        <div style="font-size: 1.1em; margin-bottom: 10px;">
          <strong>Motion:</strong> <%= motion.description %>
        </div>
        <div style="margin-bottom: 10px;">
          <strong>Outcome:</strong> 
          <span style="padding: 3px 8px; border-radius: 4px; color: white; background-color: <%= motion.outcome.downcase == 'passed' ? '#48bb78' : (motion.outcome.downcase == 'failed' ? '#e53e3e' : '#a0aec0') %>;">
            <%= motion.outcome.titleize %>
          </span>
        </div>
        
        <% if motion.votes.any? %>
          <details>
            <summary style="cursor: pointer; color: #3182ce;">View Votes (<%= motion.votes.count %>)</summary>
            <div style="margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
              <% motion.votes.includes(:member).each do |vote| %>
                <div style="padding: 5px; border: 1px solid #eee; border-radius: 4px;">
                  <strong><%= vote.member.name %>:</strong>
                  <span style="color: <%= vote.value == 'yes' ? 'green' : (vote.value == 'no' ? 'red' : 'grey') %>">
                    <%= vote.value.titleize %>
                  </span>
                </div>
              <% end %>
            </div>
          </details>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>

<% if @meeting.agenda_items.any? %>
  <h2>Agenda</h2>
  <div class="agenda-list">
    <% @meeting.agenda_items.order(:order_index).each do |item| %>
      <div class="agenda-item" style="margin-bottom: 20px; border-left: 4px solid #eee; padding-left: 15px;">
        <div style="font-weight: bold; font-size: 1.1em;">
          <% if item.number.present? %>
            <span style="color: #666; margin-right: 5px;"><%= item.number %></span>
          <% end %>
          <%= item.title %>
        </div>
        
        <% if item.topics.any? %>
          <div style="margin-top: 5px;">
            <% item.topics.each do |topic| %>
              <span style="display: inline-block; background: #e2e8f0; color: #4a5568; padding: 2px 6px; border-radius: 12px; font-size: 0.8em; margin-right: 5px;">
                <%= link_to topic.name, topic_path(topic), style: "text-decoration: none; color: inherit;" %>
              </span>
            <% end %>
          </div>
        <% end %>
        
        <% if item.summary.present? %>
          <div style="margin-top: 5px; color: #444;">
            <strong>Summary:</strong> <%= item.summary %>
          </div>
        <% end %>
        
        <% if item.recommended_action.present? %>
          <div style="margin-top: 5px; font-style: italic; color: #2c5282;">
            <strong>Action:</strong> <%= item.recommended_action %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>

<h2>Documents</h2>

<% if @meeting.meeting_documents.any? %>
  <ul>
    <% @meeting.meeting_documents.each do |doc| %>
      <li>
        <strong><%= doc.document_type.humanize %></strong>
        <% if doc.file.attached? && doc.document_type.include?("pdf") %>
          (<%= number_to_human_size(doc.file.byte_size) %>)
          <% if doc.text_quality.present? %>
            - Quality: <%= doc.text_quality.humanize %>
          <% end %>
          <br>
          <%= link_to "Download PDF", rails_blob_path(doc.file, disposition: "attachment") %>
        <% else %>
          <br>
          <%= link_to "View Original", doc.source_url, target: "_blank" %>
        <% end %>
      </li>
    <% end %>
  </ul>
<% else %>
  <p>No documents found for this meeting.</p>
<% end %>

<br>
<%= link_to "Back to Meetings", meetings_path %>
