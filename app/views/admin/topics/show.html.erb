<% content_for(:title) { "#{@topic.name} - Admin" } %>

<div class="page-header">
  <div class="flex items-center justify-between">
    <h1 class="page-title"><%= @topic.name %></h1>
    <div class="flex gap-2">
      <%= link_to "Back to Topics", admin_topics_path, class: "btn btn--secondary" %>
    </div>
  </div>
  <div class="mt-2 flex gap-2">
    <span class="badge <%= case @topic.status
      when 'approved' then 'badge--success'
      when 'blocked' then 'badge--danger'
      else 'badge--default'
    end %>"><%= @topic.status.titleize %></span>
    <% if @topic.pinned? %>
      <span class="badge badge--primary">Pinned</span>
    <% end %>
  </div>
</div>

<div class="grid grid-cols-2 gap-6">
  <div class="card p-6" id="topic-details-form">
    <h2 class="text-lg font-bold mb-4">Details</h2>
    <% if flash[:notice] %>
      <div class="flash flash--success mb-4" data-controller="auto-hide">
        <%= flash[:notice] %>
      </div>
    <% end %>
    <%= form_with model: [:admin, @topic], data: { controller: "form-feedback", action: "submit->form-feedback#submit turbo:submit-end->form-feedback#end" } do |f| %>
      <div class="form-group">
        <%= f.label :name, "Canonical Name" %>
        <%= f.text_field :name, class: "form-input w-full" %>
      </div>
      <div class="form-group">
        <%= f.label :description, "Description" %>
        <%= f.text_area :description, rows: 4, class: "form-input w-full" %>
      </div>
      <div class="form-group">
        <%= f.label :importance, "Importance (0-10)" %>
        <%= f.number_field :importance, min: 0, max: 10, class: "form-input w-full" %>
      </div>
      <div class="form-group mt-4 flex gap-2 flex-wrap">
        <%= f.submit "Update Topic", class: "btn btn--primary", data: { form_feedback_target: "submit" } %>
        
        <% if @topic.status == "proposed" %>
          <%= link_to "Approve", approve_admin_topic_path(@topic), data: { turbo_method: :post }, class: "btn btn--success" %>
        <% end %>
        
        <% unless @topic.status == "blocked" %>
          <%= link_to "Block", block_admin_topic_path(@topic), data: { turbo_method: :post }, class: "btn btn--danger" %>
        <% else %>
          <%= link_to "Unblock", unblock_admin_topic_path(@topic), data: { turbo_method: :post }, class: "btn btn--secondary" %>
        <% end %>
        
        <% unless @topic.pinned? %>
          <%= link_to "Pin", pin_admin_topic_path(@topic), data: { turbo_method: :post }, class: "btn btn--secondary" %>
        <% else %>
          <%= link_to "Unpin", unpin_admin_topic_path(@topic), data: { turbo_method: :post }, class: "btn btn--secondary" %>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="card p-6">
    <h2 class="text-lg font-bold mb-4">Aliases & Merging</h2>
    <% if @aliases.any? %>
      <ul class="list-disc pl-5 mb-6">
        <% @aliases.each do |a| %>
          <li class="mb-1"><%= a.name %></li>
        <% end %>
      </ul>
    <% else %>
      <p class="text-secondary mb-6">No aliases found.</p>
    <% end %>

    <div class="border-t pt-4 mb-6">
      <h3 class="text-md font-bold mb-2">Add Manual Alias</h3>
      <%= form_with url: create_alias_admin_topic_path(@topic), local: true, class: "flex gap-2" do |f| %>
        <%= f.text_field :name, class: "form-input grow", placeholder: "e.g. alternate spelling" %>
        <%= f.submit "Add", class: "btn btn--secondary" %>
      <% end %>
    </div>

    <div class="border-t pt-4">
      <h3 class="text-md font-bold mb-2 text-danger">Merge into another Topic</h3>
      <p class="text-sm text-secondary mb-2">Move everything to a target topic. <strong>This topic will be deleted.</strong></p>
      
      <button type="button" 
              class="btn btn--danger w-full justify-center" 
              data-controller="modal-trigger" 
              data-action="click->modal-trigger#open" 
              data-modal-trigger-topic-id-value="<%= @topic.id %>" 
              data-modal-trigger-topic-name-value="<%= @topic.name %>">
        Merge / Alias To...
      </button>
    </div>
  </div>
</div>

<div class="mt-6">
  <h2 class="text-lg font-bold mb-4">Recent Mentions</h2>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Meeting</th>
          <th style="width: 50%;">Agenda Item</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        <% @recent_mentions.each do |agenda_item| %>
          <% preview = topic_mention_preview(agenda_item, @topic, window: @preview_window) %>
          <tr>
            <td style="white-space: nowrap;">
              <%= link_to agenda_item.meeting.body_name, meeting_path(agenda_item.meeting) %>
            </td>
            <td>
              <div class="font-bold"><%= agenda_item.title %></div>
              <% if preview %>
                <div class="text-sm mt-2" style="background-color: var(--color-surface); padding: var(--space-2); border-radius: var(--radius-sm); border: 1px solid var(--color-border);">
                  <div class="mb-1" style="font-style: italic; color: var(--color-text-secondary);">
                    &ldquo;<%= highlight_preview_terms(preview[:text], preview[:terms]) %>&rdquo;
                  </div>
                  <div class="text-xs text-secondary">
                    &mdash; <%= preview[:document_type].to_s.humanize %>
                    <% if preview[:page_number].present? %>
                      (Page <%= preview[:page_number] %>)
                    <% end %>
                  </div>
                </div>
              <% else %>
                 <div class="text-xs text-secondary mt-1" style="font-style: italic;">Preview unavailable</div>
              <% end %>
            </td>
            <td style="white-space: nowrap;">
              <%= agenda_item.meeting.starts_at&.to_date %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<%= render "merge_modal" %>
