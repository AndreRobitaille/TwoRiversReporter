<% content_for(:title) { "#{@topic.name} - Topics - Two Rivers Reporter" } %>

<%# === 1. Header === %>
<div class="page-header">
  <h1 class="page-title"><%= @topic.name %></h1>
  <% if @topic.description.present? %>
    <p class="page-subtitle"><%= @topic.description %></p>
  <% end %>
</div>

<%# === 2. Coming Up === %>
<% if @upcoming.any? %>
  <section class="topic-upcoming section">
    <h2 class="section-title">Coming Up</h2>
    <div class="card-grid">
      <% @upcoming.each do |appearance| %>
        <%= link_to meeting_path(appearance.meeting), class: "card card-link card-link--upcoming" do %>
          <div class="card-body">
            <div class="text-sm text-secondary mb-1">
              <%= appearance.meeting.body_name %>
            </div>
            <div class="font-bold mb-1">
              <%= appearance.meeting.starts_at.strftime("%A, %B %-d at %-I:%M %p") %>
            </div>
            <% if appearance.meeting.location.present? %>
              <div class="text-sm text-secondary mb-2">
                <%= appearance.meeting.location %>
              </div>
            <% end %>
            <% if appearance.agenda_item %>
              <div class="mb-2">
                <%= appearance.agenda_item.title %>
              </div>
              <% if public_comment_meeting?(appearance.agenda_item) %>
                <span class="badge badge--info mb-2">Public comment period</span>
              <% end %>
            <% end %>
            <div class="card-link-arrow">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
    <p class="text-sm text-secondary mt-3">
      You can always contact your council members about this topic.
    </p>
  </section>
<% end %>

<%# === 3. What's Happening === %>
<% if @summary %>
  <section class="topic-summary section topic-section">
    <h2 class="section-title">What's Happening</h2>
    <div class="card">
      <div class="card-body topic-summary-content">
        <%= sanitize(render_topic_summary_content(@summary.content)) %>
      </div>
    </div>
  </section>
<% end %>

<%# === 4. Recent Activity === %>
<% if @recent_activity.any? %>
  <section class="topic-recent-activity section topic-section">
    <h2 class="section-title">Recent Activity</h2>
    <div class="topic-activity-list">
      <% @recent_activity.each do |appearance| %>
        <div class="topic-activity-item">
          <div class="flex justify-between items-center">
            <span class="font-bold"><%= appearance.meeting.body_name %></span>
            <span class="text-sm text-secondary">
              <%= appearance.appeared_at.strftime("%B %-d, %Y") %>
            </span>
          </div>
          <% if appearance.agenda_item %>
            <% appearance.agenda_item.motions.each do |motion| %>
              <div class="mt-2">
                <span class="badge <%= case motion.outcome&.downcase
                  when 'passed', 'adopted', 'approved' then 'badge--success'
                  when 'failed', 'defeated' then 'badge--danger'
                  else 'badge--default'
                end %>">
                  <%= motion_outcome_text(motion) %>
                </span>
              </div>
            <% end %>
            <div class="mt-1 text-sm text-secondary"><%= appearance.agenda_item.title %></div>
          <% end %>
          <div class="mt-3">
            <%= link_to "View meeting →", meeting_path(appearance.meeting),
                class: "btn btn--secondary btn--sm" %>
          </div>
        </div>
      <% end %>
    </div>
  </section>
<% end %>

<%# === 5. Key Decisions === %>
<% if @decisions.any? %>
  <section class="topic-decisions section topic-section">
    <h2 class="section-title">Key Decisions</h2>
    <% @decisions.each do |motion| %>
      <div class="topic-decision-item">
        <div class="flex justify-between items-center mb-1">
          <span class="font-bold"><%= motion.meeting.body_name %></span>
          <span class="text-sm text-secondary">
            <%= motion.meeting.starts_at.strftime("%B %-d, %Y") %>
          </span>
        </div>
        <div class="mb-2"><%= motion.description %></div>
        <div class="mb-2">
          <span class="badge <%= case motion.outcome&.downcase
            when 'passed', 'adopted', 'approved' then 'badge--success'
            when 'failed', 'defeated' then 'badge--danger'
            else 'badge--default'
          end %>">
            <%= motion_outcome_text(motion) %>
          </span>
        </div>
        <% if motion.votes.any? %>
          <div class="votes-label text-sm font-medium text-secondary">How they voted</div>
          <div class="votes-grid">
            <% motion.votes.each do |vote| %>
              <div class="vote-card vote-card--<%= vote.value %> text-sm">
                <span class="font-bold"><%= vote.member.name %></span>
                <span class="vote-value--<%= vote.value %>"><%= vote.value.titleize %></span>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  </section>
<% end %>

<%# === Empty state === %>
<% if @upcoming.empty? && @summary.nil? && @recent_activity.empty? && @decisions.empty? %>
  <div class="topic-empty-state empty-state">
    <p class="mb-0">No meeting activity recorded for this topic yet.</p>
  </div>
<% end %>

<%# === Footer === %>
<div class="mt-8">
  <%= link_to "← Back to Topics", topics_path, class: "btn btn--secondary" %>
</div>
